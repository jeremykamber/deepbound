---
date: 2026-02-19T19:28:25-08:00
git_commit: 0bcc3e9bb0a0d90596c7a0e8790e54dbbc4cf9bd
branch: feat/pricing-page-html-compacting
repository: ai_user_testing_mvp
topic: "Pricing Page Analysis: Scrolled Viewport and HTML Summarization"
tags: [research, codebase, pricing-analysis, llm, vision, html-summarization]
status: complete
---

# Research: Pricing Page Analysis: Scrolled Viewport and HTML Summarization

## Research Question
Refactor the pricing page analysis/audit to:
1. Feed the model only the screenshot of the pricing page at the scrolled position.
2. Use a small LLM to summarize the HTML page (compacting) at that current state (after scrolling/activation).
3. The summary must be objective (links, text, website topic, product info, etc.).
4. Use the summary as context for the vision models doing the per-persona analysis.

## Summary
The current system performs a "scouting" phase where it scrolls to find pricing information. After scouting, it captures a **full-page** screenshot and uses HTML captured **before** the scrolling scan. The analysis then feeds this full-page screenshot and raw HTML to a vision model for each persona. 

The proposed refactor will change the state capture to occur **after** scrolling, using only the **viewport** screenshot, and replacing the raw HTML with a **compacted summary** generated by a small LLM.

## Detailed Findings

### ParsePricingPageUseCase
- **Location:** `src/application/usecases/ParsePricingPageUseCase.ts`
- **Function:** Orchestrates the entire process from navigation to persona analysis.
- **Key Logic:**
    - `pageHtml = await this.browserService.getCleanedHtml();` (Line 98) - This is currently done *before* the linear scroll scan.
    - Scouting strategies (Targeted Strike or Fallback Linear Scan) are used to find pricing (Lines 104-164).
    - `capturedScreenshot = await this.browserService.captureFullPage();` (Line 169) - Currently captures the whole page.
    - Persona analysis calls `this.llmService.analyzePricingPageStream` or `analyzePricingPageCompletion` (Lines 234, 257), passing the `capturedScreenshot` and `pageHtml`.
- **Planned Changes:** 
    - Move HTML capture to *after* scouting to ensure dynamic content is "activated".
    - Change `captureFullPage()` to `captureViewport()` to get exactly what's visible.
    - Inject an LLM call to summarize the captured HTML before passing it to the persona analysis.

### VisionAnalysisAdapter
- **Location:** `src/infrastructure/adapters/VisionAnalysisAdapter.ts`
- **Function:** Formulates the prompt and system instructions for the vision-based persona analysis.
- **Logic:**
    - `analyzePricingPageStream` (Line 14) and `analyzePricingPageCompletion` (Line 161) build the `system` and `prompt` strings.
    - Grounding rules (Lines 42-45) instruct the model to use HTML for data and screenshots for layout/emotion.
- **Planned Changes:** 
    - Adjust the instructions to handle the summarized HTML instead of raw HTML.
    - Update prompt engineering to leverage the "compacted" context.

### LlmServiceImpl & Ports
- **Location:** `src/infrastructure/adapters/LlmServiceImpl.ts` and `src/domain/ports/LlmServicePort.ts`
- **Function:** Defines and implements the LLM gateway.
- **Planned Changes:** 
    - Add `summarizeHtml(html: string): Promise<string>` to `LlmServicePort`.
    - Implement `summarizeHtml` in `LlmServiceImpl` using a small model like `google/gemma-3-12b-it`.

### Browser Adapters
- **Location:** `src/infrastructure/adapters/RemotePlaywrightAdapter.ts` and `src/domain/ports/BrowserServicePort.ts`
- **Function:** Handles low-level browser interactions.
- **Key Logic:**
    - `getCleanedHtml()` (Line 216) already cleans the DOM by removing noisy tags (script, style, svg, etc.) and keeping meaningful nodes (h1-h6, button, a).
    - `captureViewport()` (Line 182) and `captureFullPage()` (Line 196) are available.

## Code References
- `src/application/usecases/ParsePricingPageUseCase.ts:169` - Capture full-page screenshot logic.
- `src/infrastructure/adapters/VisionAnalysisAdapter.ts:54` - Prompt construction for vision analysis.
- `src/infrastructure/adapters/RemotePlaywrightAdapter.ts:216` - DOM cleaning logic used for scouting context.

## Open Questions
- What is the ideal model for the "compacting" summarization? (`gemma-3-12b-it` is suggested by the user's preference for small models).
- Should the "compacted" summary follow a strict JSON schema or just be a structured text block?
- How much "activation" (Framer Motion, etc.) is actually triggered by the current scrolling logic, and do we need to wait longer at the final position?
